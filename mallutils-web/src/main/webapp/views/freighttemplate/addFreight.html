<!DOCTYPE html>
<!--
  ~ 版权所有:杭州火图科技有限公司
  ~ 地址:浙江省杭州市滨江区西兴街道阡陌路智慧E谷B幢4楼在地图中查看
  ~
  ~ (c) Copyright Hangzhou Hot Technology Co., Ltd.
  ~ Floor 4,Block B,Wisdom E Valley,Qianmo Road,Binjiang District
  ~ 2013-2016. All rights reserved.
  -->

<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">

<!--/*@thymesVar id="deliveryTypes" type="com.huotu.mallutils.service.ienum.DeliveryTypeEnum[]"*/-->
<!--/*@thymesVar id="freightTemplate" type="com.huotu.mallutils.service.entity.config.FreightTemplate"*/-->

<head>
    <meta charset="UTF-8">
    <title>新增运费模板</title>
    <link rel="stylesheet" href="http://resali.huobanplus.com/cdn/normalize/4.2.0/normalize.css">
    <link rel="stylesheet" href="../../resource/css/freight.css">
</head>
<body>

<div id="content" th:object="${freightTemplate}">
    <h4>新增运费模板</h4>

    <form name="tplForm" id="tplForm">
        <div class="from-group">
            <label class="label">模板名称：</label>
            <input type="text" name="name" th:value="*{name}" validate="required"/>
        </div>
        <div class="from-group">
            <label class="label">是否包邮：</label>

            <div class="check-group">
                <p><input class="input-check" type="radio" name="Is_ShippingFree" value="0"
                          th:checked="${freightTemplate == null} or *{isShippingFree==0}" checked="checked"/>买家承担运费</p>

                <p><input class="input-check" type="radio" name="Is_ShippingFree" th:checked="*{isShippingFree==1}" value="1"/>卖家承担运费</p>
            </div>
        </div>
        <div class="from-group notFree">
            <label class="label">计价方式：</label>

            <div class="check-group">
                <p><input class="input-check" type="radio" name="valuationWay" value="0"
                          th:checked="${freightTemplate == null} or *{valuationWay==0}" checked="checked"/>按件计价</p>

                <p><input class="input-check" type="radio" name="valuationWay" th:checked="*{valuationWay==1}" value="1"/>按重计价（g）</p>
            </div>
        </div>
    </form>
    <div class="from-group notFree">
        <label class="label"> 运送方式：</label>

        <p class="text-group gray">除指定地区外，其余地区的运费采用“默认运费”。至少要选择一项运送方式。</p>
    </div>

    <div class="from-group notFree" th:each="deliveryType:${deliveryTypes}">
        <div>
            <p class="text-group" style="padding-left: 124px;">
                <input class="chkDeliveryType"
                       th:checked="${freightTemplate.defaultDetail(deliveryType)!=null}" type="checkbox" name="deliveryType" value="0" th:value="${deliveryType.code}"/>
                <span th:text="${deliveryType.code}">快递</span>
            </p>

            <div style="display: none;" class="detailSet">
                <p class="text-group mixture gray">
                    <input type="hidden" name="detailId0" value="0"/>
                    <input type="hidden" name="areaIdGroup0"/>
                    <input type="hidden" name="areaDesc0"/>
                    <input type="hidden" name="isDefault0" value="1"/>

                    <span class="char">默认运费</span>
                    <input type="text" value="1" name="firstItem0" validate="required"/>
                    <span class="char"><span class="unit">件</span>内，</span>
                    <input type="text" name="firstFreight0" validate="required"/>
                    <span class="char">元，</span>
                    <span class="char">每增加</span>
                    <input type="text" value="1" name="nextItem0" validate="required"/>
                    <span class="char"><span class="unit">件</span>，</span>
                    <span class="char">增加运费</span>
                    <input type="text" name="nextFreight0" validate="required"/>
                    <span class="char">元</span>
                </p>
                <table class="addTpl" cellspacing="0">
                    <thead>
                    <tr>
                        <th>运送到</th>
                        <th>首<span class="unit">件</span></th>
                        <th>远费(元)</th>
                        <th>续<span class="unit">件</span></th>
                        <th>续费(元)</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p class="addOne">
                    <a style="cursor: pointer;" onclick="freightHandler.addRule(this,0);" class="addRule">为指定地区城市设置运费</a>
                </p>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <input class="btn submit" type="button" onclick="freightHandler.submitForm();" value="保存">
    </div>
</div>
</body>
<script src="http://resali.huobanplus.com/cdn/jquery/1.9.1/jquery.min.js"></script>
<script>
    var canSubmit = true;

    var freightHandler = {
        addRule: function (obj, deliveryType) {
            var tr = $("#detail_template").html();
            tr = tr.replace(/{deliveryType}/g, deliveryType);
            $(obj).parent().parent().find('tbody').append(tr);
        },
        submitForm: function () {

            var chkDeliveryTypes = $("input[name=deliveryType]:checked");
            if (chkDeliveryTypes.length == 0) {
                alert("请选择运送方式");
            }

            //表单验证--使用jquery validate

            var freightTemplateDetails = [];

            $("input[name=deliveryType]:checked").each(function () {
                var deliveryType = $(this).val();
                var detailIdDoms = $("input[name=detailId" + deliveryType + "]");
                var isDefaultDoms = $("input[name=isDefault" + deliveryType + "]");
                var areaIdGroupDoms = $("input[name=areaIdGroup" + deliveryType + "]");
                var areaDescDoms = $("input[name=areaDesc" + deliveryType + "]");
                var firstItemDoms = $("input[name=firstItem" + deliveryType + "]");
                var firstFreightDoms = $("input[name=firstFreight" + deliveryType + "]");
                var nextItemDoms = $("input[name=nextItem" + deliveryType + "]");
                var nextFreightDoms = $("input[name=nextFreight" + deliveryType + "]");

                detailIdDoms.each(function (index, element) {
                    var freightTemplateDetail = {
                        id: element.value,
                        deliveryType: deliveryType,
                        isDefault: isDefaultDoms[index].value,
                        areaDesc: areaDescDoms[index].value,
                        areaIdGroup: areaIdGroupDoms[index].value,
                        firstItem: firstItemDoms[index].value,
                        firstFreight: firstFreightDoms[index].value,
                        nextItem: nextItemDoms[index].value,
                        nextFreight: nextFreightDoms[index].value
                    };
                    freightTemplateDetails.push(freightTemplateDetail);
                });
            });
        }
    };

    $(function () {
        $('.addTpl').on('click', '.areaFeeDelete', function () {
            $(this).parentsUntil('tbody').empty();
        });

        $('body').on('blur', 'input[validate=required]', function () {
            if ($.trim($(this).val()).length == 0) {
                $(this).css("border", "1px solid red");
            }
        });

        $(".chkDeliveryType").change(function () {
            if ($(this).is(':checked')) {
                $(this).parent().parent().find('div').show();
            } else {
                $(this).parent().parent().find('div').hide();
            }
        });

        $("input[name=valuationWay]").change(function () {
            if ($("input[name=valuationWay]:checked").val() == "0") {
                $(".unit").html("件");
            } else {
                $(".unit").html("重");
            }
        });
        $("input[name=Is_ShippingFree]").change(function () {
            if ($("input[name=Is_ShippingFree]:checked").val() == "0") {
                $(".notFree").show();
            } else {
                $(".notFree").hide();
            }
        })
    });
</script>
</html>

<script type="text/html" id="detail_template">
    <tr>
        <td>
            <input type="hidden" name="detailId{deliveryType}" value="0"/>
            <input type="hidden" name="areaIdGroup{deliveryType}"/>
            <input type="hidden" name="isDefault{deliveryType}" value="0"/>

            <div class="city-picker">
                <input readonly="readonly" type="text" placeholder="请选择省/市"
                       name="areaDesc{deliveryType}" class="input-area" validate="required"/>
            </div>
        </td>
        <td class="center">
            <input type="text" value="1" name="firstItem{deliveryType}" class="input-text input-mini" validate="required"/>
        </td>
        <td class="center">
            <input type="text" name="firstFreight{deliveryType}" class="input-text input-mini" validate="required"/>
        </td>
        <td class="center">
            <input type="text" value="1" name="nextItem{deliveryType}" class="input-text input-mini" validate="required"/>
        </td>
        <td class="center">
            <input type="text" name="nextFreight{deliveryType}" class="input-text input-mini" validate="required"/>
        </td>
        <td class="center">
            <a class="areaFeeDelete" href="javascript:;">删除</a>
        </td>
    </tr>
</script>
